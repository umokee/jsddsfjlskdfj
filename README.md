# Task Manager с системой поинтов

Комплексный менеджер задач и привычек с геймификацией через систему поинтов. Построен на FastAPI backend и React frontend.

## Содержание

- [Возможности](#возможности)
- [Быстрый старт](#быстрый-старт)
- [Структура проекта](#структура-проекта)
- [Система поинтов](#система-поинтов)
- [Справочник API](#справочник-api)
- [Справочник настроек](#справочник-настроек)
- [Миграция базы данных](#миграция-базы-данных)
- [Деплой](#деплой)
- [Безопасность](#безопасность)

---

## Возможности

### Основные функции
- **Управление задачами**: Приоритет (0-10), Энергия (0-5), Сроки выполнения
- **Отслеживание привычек**: Ежедневные привычки с подсчётом стрика (максимум 30 дней)
- **Зависимости задач**: Последовательные цепочки задач (Задача B зависит от Задачи A)
- **Ежедневное планирование**: Умный алгоритм "Roll" для выбора задач на день
- **Система поинтов**: Комплексная геймификация с наградами и штрафами
- **Цели**: Установка целей на основе поинтов с отслеживанием вознаграждений
- **Калькулятор поинтов**: Прогноз будущих поинтов на основе производительности

### Возможности системы поинтов
- Автоматический подсчёт поинтов при выполнении задач
- Бонусы за стрик привычек (ограничение 30 дней)
- Множители на основе энергии
- Бонусы за эффективность по времени
- Прогрессивные штрафы за последовательные дни со штрафами
- Раздельные штрафы для задач и привычек
- Типы привычек: Навыки (полные поинты) vs Рутина (50% поинтов)
- Поддержка дней отдыха (без штрафов)

### Технические возможности
- Аутентификация по API ключу
- Интеграция с Fail2ban для безопасности
- База данных SQLite с автоматическими миграциями
- Адаптивный UI в стиле терминала
- Модуль для деплоя на NixOS

---

## Быстрый старт

### Backend

```bash
cd backend
pip install -r requirements.txt

# Установить API ключ (опционально, по умолчанию: "your-secret-key-change-me")
export TASK_MANAGER_API_KEY="your-secret-key"

# Запустить сервер
python -m backend.main
```

Backend запускается на `http://localhost:8000`

### Frontend

```bash
cd frontend
npm install

# Установить API ключ и URL в .env (или использовать значения по умолчанию)
echo "VITE_API_KEY=your-secret-key" > .env
echo "VITE_API_URL=http://localhost:8000" >> .env

npm run dev
```

Frontend запускается на `http://localhost:5173`

### Первый запуск

1. Откройте `http://localhost:5173` в браузере
2. Система автоматически создаст настройки по умолчанию
3. Создайте первую задачу или привычку
4. Нажмите "Roll Daily Plan" для выбора задач на сегодня
5. Выполняйте задачи и зарабатывайте поинты!

---

## Структура проекта

```
umtask/
├── backend/
│   ├── __init__.py
│   ├── main.py              # FastAPI приложение и все API эндпоинты
│   ├── models.py            # Модели базы данных SQLAlchemy
│   ├── schemas.py           # Схемы валидации Pydantic
│   ├── crud.py              # Бизнес-логика и расчёты
│   ├── auth.py              # Аутентификация по API ключу
│   ├── requirements.txt     # Python зависимости
│   ├── migrate_db.py        # Скрипт миграции БД
│   └── tasks.db             # SQLite база данных (создаётся при первом запуске)
│
├── frontend/
│   ├── src/
│   │   ├── components/
│   │   │   ├── TaskForm.jsx         # Создание/редактирование задач
│   │   │   ├── TaskList.jsx         # Отображение списка задач
│   │   │   ├── HabitList.jsx        # Отображение списка привычек
│   │   │   ├── Timer.jsx            # Таймер задачи
│   │   │   ├── Settings.jsx         # Настройки системы поинтов
│   │   │   ├── PointsDisplay.jsx    # Поинты и история
│   │   │   ├── PointsGoals.jsx      # Управление целями
│   │   │   └── PointsCalculator.jsx # Прогнозы на будущее
│   │   ├── App.jsx          # Главный компонент приложения
│   │   ├── App.css          # Глобальные стили
│   │   └── api.js           # Axios API клиент
│   ├── index.html
│   ├── package.json
│   └── vite.config.js
│
├── deployment/
│   ├── nixos-module.nix     # Модуль сервиса для NixOS
│   ├── NIXOS-SETUP.md       # Руководство по деплою на NixOS
│   └── FAIL2BAN.md          # Руководство по настройке Fail2ban
│
└── README.md                # Этот файл
```

---

## Система поинтов

### Обзор

Система поинтов геймифицирует выполнение задач с наградами за продуктивность и штрафами за бездействие.

### Заработок поинтов

#### Выполнение задачи

```
Базовые поинты: 10 (настраивается)
Бонус за энергию: уровень_энергии × вес_энергии (по умолчанию: 3.0)
Бонус за эффективность: (1 - затраченное_время/ожидаемое_время) × вес_эффективности (по умолчанию: 0.5)

Формула:
поинты = база + (энергия × вес) + бонус_за_эффективность
```

**Пример:**
- Задача с энергией=3, выполнена за ожидаемое время
- Поинты = 10 + (3 × 3.0) + 0 = **19 поинтов**

#### Выполнение привычки

```
Базовые поинты: 10 (настраивается)
Бонус за стрик: min(текущий_стрик, 30) × множитель_стрика (по умолчанию: 1.0)
Множитель типа привычки:
  - Навык: 1.0 (полные поинты)
  - Рутина: 0.5 (половина поинтов)

Формула:
поинты = (база + бонус_за_стрик) × множитель_типа_привычки
```

**Пример:**
- Навык с 15-дневным стриком
- Поинты = (10 + 15 × 1.0) × 1.0 = **25 поинтов**

**Пример рутины:**
- Рутинная привычка (например "почистить зубы") с 20-дневным стриком
- Поинты = (10 + 20 × 1.0) × 0.5 = **15 поинтов**

### Штрафы

#### Штраф за бездействие (задачи)
Применяется когда **0 задач** выполнено за день
- По умолчанию: -20 поинтов
- Применяется независимо от привычек

#### Штраф за бездействие (привычки)
Применяется когда **0 привычек** выполнено за день
- По умолчанию: -20 поинтов
- Применяется независимо от задач

#### Штраф за неполный день
Применяется когда процент выполнения < порога
- По умолчанию: -20 поинтов
- Порог: 80% (настраивается)
- Применяется только если задачи были запланированы

#### Штраф за пропуск привычки
Применяется за каждую невыполненную привычку
```
Базовый штраф: 50 (настраивается)
Множитель типа привычки:
  - Навык: 1.0
  - Рутина: 0.5

Формула:
штраф = база × множитель_типа_привычки
```

#### Прогрессивные штрафы (Surge Pricing)

Штрафы увеличиваются на основе **стрика штрафов** (последовательные дни СО штрафами):

```
Стрик штрафов: Количество последовательных дней с любыми штрафами
Сброс: После 3 последовательных дней без штрафов (настраивается)

Формула:
итоговый_штраф = базовый_штраф × (1 + фактор × стрик_штрафов)

Где фактор = progressive_penalty_factor (по умолчанию: 0.5)
```

**Пример:**
- День 1: -20 штраф → стрик = 1 → -20 × (1 + 0.5×1) = **-30 поинтов**
- День 2: -20 штраф → стрик = 2 → -20 × (1 + 0.5×2) = **-40 поинтов**
- День 3: -20 штраф → стрик = 3 → -20 × (1 + 0.5×3) = **-50 поинтов**
- День 4: Нет штрафа 1 день (стрик всё ещё активен)
- День 5-7: Нет штрафа 3 дня → **стрик сбрасывается на 0**

### Зависимости задач

Задачи могут зависеть от выполнения других задач.

**Поведение алгоритма Roll:**
1. **Проход 1**: Выбирает задачи с выполненными зависимостями (или без зависимостей)
2. **Проход 2**: Если остались слоты, выбирает задачи, чья зависимость в плане на сегодня
3. Зависимые задачи можно выполнить сегодня после их зависимости

**Пример:**
- Задача A: "Изучить React" (нет зависимости)
- Задача B: "Построить проект на React" (зависит от A)
- Roll выбирает A → B также может быть выбрана (обе в плане на сегодня)

### Типы привычек

**Навыки** (habit_type='skill'):
- Новые привычки, которые вы строите
- Полные поинты и штрафы
- Примеры: Упражнения, медитация, обучение

**Рутина** (habit_type='routine'):
- Лёгкие ежедневные задачи
- 50% поинтов и штрафов (настраивается)
- Примеры: Почистить зубы, застелить кровать, душ

### Дни отдыха

Специальные даты без применения штрафов:
- Создание через API: `POST /api/rest-days`
- Примеры: Праздники, дни отпуска, больничные
- Поинты начисляются нормально, но штрафов нет

---

## Справочник API

Все эндпоинты требуют заголовок `X-API-Key` с вашим API ключом.

### Задачи

#### Получить все задачи
```http
GET /api/tasks
```

Возвращает все задачи с рассчитанной срочностью.

#### Получить ожидающие задачи
```http
GET /api/tasks/pending
```

Возвращает ожидающие задачи, отсортированные по срочности (сначала высокая).

#### Получить текущую задачу
```http
GET /api/tasks/current
```

Возвращает текущую активную задачу или следующую задачу, если нет активной.

#### Получить сегодняшние привычки
```http
GET /api/tasks/habits
```

Возвращает все привычки на сегодня.

#### Получить сегодняшние задачи
```http
GET /api/tasks/today
```

Возвращает все задачи, отмеченные на сегодня (is_today=true).

#### Получить конкретную задачу
```http
GET /api/tasks/{task_id}
```

Возвращает задачу по ID.

#### Создать задачу
```http
POST /api/tasks
Content-Type: application/json

{
  "description": "Описание задачи",
  "project": "Название проекта",
  "priority": 5,
  "energy": 3,
  "is_habit": false,
  "is_today": false,
  "due_date": "2024-01-15T00:00:00",
  "depends_on": null,
  "habit_type": "skill",
  "recurrence_type": "none"
}
```

**Поля:**
- `description` (обязательно): Описание задачи
- `project`: Опциональное название проекта
- `priority`: 0-10, влияет на расчёт срочности
- `energy`: 0-5, влияет на поинты и срочность
- `is_habit`: Это привычка?
- `is_today`: Запланировать на сегодня?
- `due_date`: ISO datetime (время игнорируется, устанавливается полночь)
- `depends_on`: ID задачи, от которой зависит эта (только задачи)
- `habit_type`: "skill" или "routine" (только привычки)
- `recurrence_type`: "none", "daily", "every_n_days", "weekly" (только привычки)

#### Обновить задачу
```http
PUT /api/tasks/{task_id}
Content-Type: application/json

{
  "description": "Обновлённое описание",
  "priority": 7
}
```

#### Удалить задачу
```http
DELETE /api/tasks/{task_id}
```

### Действия с задачами

#### Начать задачу
```http
POST /api/tasks/start?task_id=123
```

Начинает указанную задачу (или следующую, если ID не указан). Останавливает любую активную задачу.

#### Остановить задачу
```http
POST /api/tasks/stop
```

Останавливает текущую активную задачу.

#### Завершить задачу
```http
POST /api/tasks/done?task_id=123
```

Завершает указанную задачу (или текущую, если ID не указан). Начисляет поинты.

#### Roll ежедневного плана
```http
POST /api/tasks/roll?mood=3&daily_limit=5&critical_days=2
```

Генерирует ежедневный план задач. Должен вызываться один раз в день.

**Параметры:**
- `mood` (опционально): 0-5, фильтрует задачи по уровню энергии
- `daily_limit`: Максимум задач для выбора (по умолчанию: 5)
- `critical_days`: Дни до дедлайна для критических задач (по умолчанию: 2)

**Алгоритм:**
1. Удаляет просроченные привычки с предыдущих дней
2. Очищает флаг is_today со всех обычных задач
3. Выбирает критические задачи (срок в течение critical_days)
4. Заполняет оставшиеся слоты задачами с выполненными зависимостями
5. Если остались слоты, добавляет задачи, чья зависимость в плане на сегодня
6. Рассчитывает штрафы за вчера
7. Обновляет last_roll_date

### Поинты

#### Получить текущие поинты
```http
GET /api/points/current
```

Возвращает общее количество накопленных поинтов.

#### Получить историю поинтов
```http
GET /api/points/history?days=7
```

Возвращает историю поинтов по дням.

**Ответ:**
```json
[
  {
    "id": 1,
    "date": "2024-01-15",
    "points_earned": 45,
    "points_penalty": 20,
    "daily_total": 25,
    "tasks_completed": 3,
    "tasks_planned": 5,
    "habits_completed": 2,
    "completion_rate": 0.6,
    "penalty_streak": 1
  }
]
```

#### Получить прогноз поинтов
```http
GET /api/points/projection?target_date=2024-12-31
```

Прогнозирует будущие поинты на основе среднего за последние 30 дней.

**Ответ:**
```json
{
  "current_total": 500,
  "target_date": "2024-12-31",
  "days_until": 90,
  "avg_per_day": 10,
  "min_projection": 1130,
  "avg_projection": 1400,
  "max_projection": 1670
}
```

Прогнозы:
- **Минимум**: 70% от среднего (пессимистичный)
- **Средний**: Текущий средний (реалистичный)
- **Максимум**: 130% от среднего (оптимистичный)

### Цели

#### Получить цели
```http
GET /api/goals?include_achieved=false
```

Возвращает активные цели (или все, если include_achieved=true).

#### Создать цель
```http
POST /api/goals
Content-Type: application/json

{
  "target_points": 1000,
  "reward_description": "Купить новый ноутбук",
  "deadline": "2024-12-31"
}
```

#### Обновить цель
```http
PUT /api/goals/{goal_id}
Content-Type: application/json

{
  "reward_description": "Обновлённое вознаграждение"
}
```

Цели автоматически отмечаются как достигнутые, когда поинты достигают цели.

#### Удалить цель
```http
DELETE /api/goals/{goal_id}
```

### Дни отдыха

#### Получить дни отдыха
```http
GET /api/rest-days
```

Возвращает все дни отдыха (будущие и прошлые).

#### Создать день отдыха
```http
POST /api/rest-days
Content-Type: application/json

{
  "date": "2024-12-25",
  "description": "Рождество"
}
```

#### Удалить день отдыха
```http
DELETE /api/rest-days/{rest_day_id}
```

### Настройки

#### Получить настройки
```http
GET /api/settings
```

Возвращает текущие настройки системы поинтов.

#### Обновить настройки
```http
PUT /api/settings
Content-Type: application/json

{
  "points_per_task_base": 15,
  "idle_tasks_penalty": 30
}
```

### Статистика

#### Получить дневную статистику
```http
GET /api/stats
```

Возвращает статистику за текущий день.

**Ответ:**
```json
{
  "pending_tasks": 5,
  "completed_tasks": 3,
  "active_habits": 8,
  "completed_habits": 5,
  "total_time": 3600,
  "current_points": 500
}
```

---

## Справочник настроек

Все настройки настраиваются через страницу Settings в UI или через API.

### Лимиты задач

| Настройка | По умолчанию | Диапазон | Описание |
|-----------|--------------|----------|----------|
| `max_tasks_per_day` | 10 | 1-100 | Максимум задач в ежедневном плане |

### Базовые поинты

| Настройка | По умолчанию | Диапазон | Описание |
|-----------|--------------|----------|----------|
| `points_per_task_base` | 10 | 1-1000 | Базовые поинты за задачу |
| `points_per_habit_base` | 10 | 1-1000 | Базовые поинты за привычку |

### Множители и веса

| Настройка | По умолчанию | Диапазон | Описание |
|-----------|--------------|----------|----------|
| `streak_multiplier` | 1.0 | 0-10 | Поинты за день стрика (ограничение 30 дней) |
| `energy_weight` | 3.0 | 0-20 | Множитель поинтов за уровень энергии |
| `time_efficiency_weight` | 0.5 | 0-5 | Влияние эффективности по времени на поинты |

### Оценка времени

| Настройка | По умолчанию | Диапазон | Описание |
|-----------|--------------|----------|----------|
| `minutes_per_energy_unit` | 30 | 5-180 | Ожидаемые минуты на уровень энергии |

**Пример:**
- Задача с энергией 3 = 3 × 30 = 90 минут ожидается

### Штрафы

| Настройка | По умолчанию | Диапазон | Описание |
|-----------|--------------|----------|----------|
| `incomplete_day_penalty` | 20 | 0-500 | Штраф за выполнение < порога |
| `incomplete_day_threshold` | 0.8 | 0-1 | Минимальный процент выполнения (80%) |
| `missed_habit_penalty_base` | 50 | 0-500 | Базовый штраф за пропуск привычки |
| `progressive_penalty_factor` | 0.5 | 0-5 | Множитель стрика штрафов |
| `penalty_streak_reset_days` | 3 | 1-30 | Дни без штрафа для сброса стрика |
| `idle_tasks_penalty` | 20 | 0-500 | Штраф за 0 выполненных задач |
| `idle_habits_penalty` | 20 | 0-500 | Штраф за 0 выполненных привычек |

### Типы привычек

| Настройка | По умолчанию | Диапазон | Описание |
|-----------|--------------|----------|----------|
| `routine_habit_multiplier` | 0.5 | 0-1 | Множитель поинтов/штрафов для рутинных привычек |

---

## Миграция базы данных

При обновлении с предыдущей версии запустите скрипт миграции:

```bash
python backend/migrate_db.py
```

**Добавляет:**
- Колонку `depends_on` в tasks (зависимости задач)
- Колонку `habit_type` в tasks (навык vs рутина)
- Колонку `penalty_streak` в point_history
- Новые колонки штрафов в settings
- `routine_habit_multiplier` в settings

Скрипт безопасно запускать несколько раз (проверяет существование колонок).

---

## Деплой

### Локальная разработка

Смотрите [Быстрый старт](#быстрый-старт) выше.

### NixOS (Рекомендуется)

Полностью автоматизированный деплой с:
- Git clone
- Сборка фронтенда
- Сервис backend
- Reverse proxy (Caddy)
- Интеграция Fail2ban
- Автоматическая генерация API ключа

**Минимальная конфигурация:**

```nix
{ config, pkgs, ... }:
{
  imports = [
    /path/to/umtask/deployment/nixos-module.nix
  ];

  services.task-manager = {
    enable = true;
    domain = "tasks.example.com";  # Опционально
  };
}
```

Смотрите `deployment/NIXOS-SETUP.md` для деталей.

### Docker (В разработке)

Деплой через Docker планируется, но пока недоступен.

### Systemd (Ручной)

1. Установите зависимости
2. Создайте systemd сервис (смотрите `deployment/systemd-service.example`)
3. Настройте reverse proxy (Nginx/Caddy)
4. Настройте Fail2ban (смотрите `deployment/FAIL2BAN.md`)

---

## Безопасность

### Аутентификация по API ключу

Все API эндпоинты требуют заголовок `X-API-Key`.

**Установить свой ключ:**

```bash
# Backend
export TASK_MANAGER_API_KEY="ваш-безопасный-случайный-ключ"

# Frontend .env
VITE_API_KEY=ваш-безопасный-случайный-ключ
```

### Интеграция Fail2ban

Автоматически логирует неудачные попытки аутентификации с IP адресами.

**Настройки по умолчанию:**
- Максимум попыток: 2
- Время бана: 52 недели
- Время поиска: 1 день

Смотрите `deployment/FAIL2BAN.md` для настройки.

### HTTPS

Используйте reverse proxy (Nginx/Caddy) для HTTPS в продакшене.

Модуль NixOS включает Caddy с автоматическим HTTPS.

---

## Технологии

**Backend:**
- FastAPI - Современный Python веб-фреймворк
- SQLAlchemy - ORM для базы данных
- SQLite - Встроенная база данных
- Pydantic - Валидация данных

**Frontend:**
- React - UI библиотека
- Vite - Инструмент сборки
- Axios - HTTP клиент
- Vanilla CSS - Без фреймворков, тема в стиле терминала

**Деплой:**
- NixOS - Декларативный деплой
- Systemd - Управление сервисами
- Fail2ban - Безопасность
- Caddy/Nginx - Reverse proxy

---

## Лицензия

MIT
